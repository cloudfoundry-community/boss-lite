#!/bin/bash

# This is the parent script for all helper commands

set -e

boss_lite_repo=${boss_lite_repo:-"https://github.com/cloudfoundry-community/boss-lite.git"}
boss_lite_branch=${boss_lite_branch:-"master"}
bosh_lite_repo=${bosh_lite_repo:-"https://github.com/cloudfoundry/bosh-lite.git"}
bosh_lite_branch=${bosh_lite_branch:-"master"}

base_path="deployments"

new() {
  name=$1; shift
  if [[ "${name}X" == "X" ]]; then
    echo "USAGE: boss-lite new NAME"
    exit 1
  fi
  path=${base_path}/${name}
  mkdir -p ${path}
  cp bosh-lite/Vagrantfile ${path}/
  cp .envrc ${path}/
  cd ${path}
  direnv allow
  vagrant up --provider=aws

  IP=$(vagrant ssh-config | grep HostName | awk '{print $2}')
  set -x
  yes admin | bosh target ${IP} ${name}
  bosh -t ${name} upload stemcell https://bosh.io/d/stemcells/bosh-warden-boshlite-ubuntu-trusty-go_agent
}

update() {
  git subtree pull --prefix boss-lite $boss_lite_repo $boss_lite_branch --squash \
    -m "Update boss-lite scripts"
  git subtree pull --prefix bosh-lite $bosh_lite_repo $bosh_lite_branch --squash \
    -m "Update bosh-lite scripts"
}

if [[ $1 =~ ^(new|update)$ ]]; then
  "$@"
else
  echo "Invalid subcommand: $1 - available: new, update" >&2
  exit 1
fi
